<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ganesh Fresh Juice Centre</title>
  <style>
    :root{ --accent:#ff7a00; --card-bg:#fff; --shadow:0 8px 20px rgba(6,10,30,0.08); --radius:12px }
    *{box-sizing:border-box} body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,hsl(93,100%,80%) 0%,hsl(93,100%,72%) 100%);color:#111}
    header{padding:18px 20px;text-align:center;background:linear-gradient(90deg,#68dcff,#a2f1ff);color:#c40b0b}
    nav{position:sticky;top:0;z-index:60;display:flex;justify-content:center;gap:12px;padding:10px;background:linear-gradient(90deg,#e45ddd,#ff6fa3)}
    nav a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:999px;font-weight:700}
    .hero{height:420px;display:flex;align-items:center;justify-content:center;color:#fff;text-align:center;background:linear-gradient(180deg,rgba(0,0,0,0.18),rgba(0,0,0,0.12)),url('j1.jpg') center/cover;padding:20px;border-bottom-left-radius:24px;border-bottom-right-radius:24px;box-shadow:var(--shadow)}
    section{padding:36px 18px;max-width:1200px;margin:0 auto}
    .menu-category{display:inline-block;background:linear-gradient(90deg,#ff9b3c,#e67e22);color:#020202;padding:10px 14px;border-radius:10px;font-weight:800;margin:20px 0}
    .menu-items{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:12px;box-shadow:0 8px 16px rgba(15,20,40,0.06);transition:transform .28s,box-shadow .28s;opacity:0;transform:translateY(18px) scale(.995);border:1px solid rgba(10,10,10,0.03)}
    .card.visible{opacity:1;transform:none}
    .card img{width:100%;height:150px;object-fit:cover;border-radius:10px}
    .delivery-box{border-radius:12px;padding:18px;margin:18px auto;max-width:680px;background:linear-gradient(180deg,#fff8f0,#fff3e6);border:3px solid rgba(255,165,0,0.12)}
    form{display:flex;flex-direction:column;max-width:760px;margin:16px auto;gap:14px}
    input,textarea,select,button{font-size:1rem}
    input,textarea,select{padding:12px;border-radius:10px;border:1px solid #e3e3e3}
    button{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:999px;cursor:pointer}
    .totals{display:flex;gap:12px;justify-content:flex-end;font-weight:700}
    .box{background:#fff;padding:8px 12px;border-radius:10px;border:1px solid #eee}
    .small{font-size:.9rem}
    .tracking-panel{position:fixed;right:18px;bottom:18px;z-index:250;background:#fff;padding:12px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.12);max-width:360px;display:none}
    .owner-panel{position:fixed;left:18px;bottom:18px;z-index:250;background:#fff;padding:12px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.12);max-width:360px;display:none}
    .confirm-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);visibility:hidden;opacity:0;transition:opacity .18s}
    .confirm-overlay.visible{visibility:visible;opacity:1}
    .confirm-box{background:#fff;padding:20px;border-radius:12px;max-width:420px;width:92%;text-align:center;box-shadow:0 18px 40px rgba(0,0,0,0.18)}
    .orderno{font-weight:900;color:#ff6b00}
    .floating-order{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#ff7a00,#ff5c00);color:#fff;z-index:240}
    @media(min-width:900px){.floating-order{display:none}}
    .btn-secondary{background:#555;color:#fff;padding:10px 12px;border-radius:10px;border:none}
    .share-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>

<header>
  <h1>Ganesh Fresh Juice Centre</h1>
  <p style="margin:4px 0 0;color:#08204a;font-weight:600">Fresh, Healthy & Natural Juices</p>
</header>

<nav id="mainNav">
  <a href="#home">Home</a>
  <a href="#menu">Menu</a>
  <a href="#about">About</a>
  <a href="#gallery">Gallery</a>
  <a href="#delivery">Delivery</a>
  <a href="#contact">Contact</a>
  <a id="ownerToggle" href="#" style="background:#fff;color:#333;padding:6px 10px;border-radius:8px;margin-left:8px">Owner Dashboard</a>
</nav>

<div class="hero" id="home"><div><h2 style="margin:0">Welcome to Ganesh Fresh Juice Centre</h2><p style="margin:.5rem 0">Natural taste, juice made with love ‚Äî open 9 AM ‚Äì 9 PM</p></div></div>

<section id="menu">
  <h1>Our Menu</h1>
  <!-- (menu unchanged ‚Äî keep your original items) -->
  <div class="menu-category">üçπ Juices</div>
  <div class="menu-items">
    <div class="card"><img src="apple.jpg" alt=""><h3>Apple Juice</h3><p>‚Çπ70</p></div>
    <div class="card"><img src="orange .jpg" alt=""><h3>Orange Juice</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="pain apple.jpg" alt=""><h3>Pineapple Juice</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="grapes .jpg" alt=""><h3>Grape Juice</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="puply grape.jpg" alt=""><h3>Pulpy Grape</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="water million .jpg" alt=""><h3>Watermelon Juice</h3><p>‚Çπ45</p></div>
    <div class="card"><img src="karbuja.jpg" alt=""><h3>Musk Melon Juice</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="carrot .jpg" alt=""><h3>Carrot Juice</h3><p>‚Çπ65</p></div>
    <div class="card"><img src="abc.webp" alt=""><h3>ABC Juice</h3><p>‚Çπ80</p></div>
    <div class="card"><img src="nalikayi.jpg" alt=""><h3>Amla Juice</h3><p>‚Çπ60</p></div>
    <div class="card"><img src="bitrot.jpg" alt=""><h3>Beetroot Juice</h3><p>‚Çπ60</p></div>
    <div class="card"><img src="lemon juice.jpg" alt=""><h3>Lemon Juice</h3><p>‚Çπ35</p></div>
    <div class="card"><img src="lemmon juice.jpg" alt=""><h3>Mosambi Juice</h3><p>‚Çπ50</p></div>
    <div class="card"><img src="Fruit bowl.jpg" alt=""><h3>Fruit Bowl</h3><p>‚Çπ80</p></div>
  </div>

  <div class="menu-category">ü•§ Shakes</div>
  <div class="menu-items">
    <div class="card"><img src="apple shake.jpg" alt=""><h3>Apple Shake</h3><p>‚Çπ70</p></div>
    <div class="card"><img src="bananas .jpg" alt=""><h3>Banana Shake</h3><p>‚Çπ45</p></div>
    <div class="card"><img src="butter fruits .jpg" alt=""><h3>Butter Fruit Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="papaya.jpg" alt=""><h3>Papaya Shake</h3><p>‚Çπ55</p></div>
    <div class="card"><img src="promogante.jpg" alt=""><h3>Pomegranate Shake</h3><p>‚Çπ75</p></div>
    <div class="card"><img src="mango.jpeg" alt=""><h3>Mango Shake</h3><p>‚Çπ75</p></div>
    <div class="card"><img src="kiwi .jpg" alt=""><h3>Kiwi Shake</h3><p>‚Çπ75</p></div>
    <div class="card"><img src="anjeer.jpg" alt=""><h3>Anjeer Shake</h3><p>‚Çπ70</p></div>
    <div class="card"><img src="dry fruit.jpg" alt=""><h3>Dry Fruit Shake</h3><p>‚Çπ120</p></div>
    <div class="card"><img src="dates.jpg" alt=""><h3>Dates Shake</h3><p>‚Çπ80</p></div>
    <div class="card"><img src="orio shake.jpg" alt=""><h3>Oreo Shake</h3><p>‚Çπ70</p></div>
    <div class="card"><img src="cold badam.jpg" alt=""><h3>Cold Badam</h3><p>‚Çπ55</p></div>
    <div class="card"><img src="cold cofee.jpg" alt=""><h3>Cold Coffee</h3><p>‚Çπ65</p></div>
    <div class="card"><img src="chocolate .jpg" alt=""><h3>Chocolate Coffee</h3><p>‚Çπ75</p></div>
    <div class="card"><img src="rose milk.jpg" alt=""><h3>Rose Milk</h3><p>‚Çπ55</p></div>
    <div class="card"><img src="sharja.jpg" alt=""><h3>Sharja</h3><p>‚Çπ75</p></div>
    <div class="card"><img src="trender coco.jpg" alt=""><h3>Tender Coconut Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="sapota.jpg" alt=""><h3>Sapota Shake</h3><p>‚Çπ60</p></div>
  </div>

  <div class="menu-category">ü•õ Lassi</div>
  <div class="menu-items">
    <div class="card"><img src="sweet lassi.jpg" alt=""><h3>Sweet Lassi</h3><p>‚Çπ45</p></div>
    <div class="card"><img src="banana lassi.jpg" alt=""><h3>Banana Lassi</h3><p>‚Çπ60</p></div>
    <div class="card"><img src="apple lassi.jpg" alt=""><h3>Apple Lassi</h3><p>‚Çπ65</p></div>
    <div class="card"><img src="mango lassi.jpeg" alt=""><h3>Mango Lassi</h3><p>‚Çπ65</p></div>
    <div class="card"><img src="pinapple lassi.jpg" alt=""><h3>Pineapple Lassi</h3><p>‚Çπ55</p></div>
    <div class="card"><img src="fruit lassi.jpg" alt=""><h3>Fruit Lassi</h3><p>‚Çπ75</p></div>
  </div>

  <div class="menu-category">üç® Ice Cream Shakes</div>
  <div class="menu-items">
    <div class="card"><img src="butter scorch ice cream .jpg" alt=""><h3>Butterscotch Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="chocolate .jpg" alt=""><h3>Chocolate Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="pista ice cream shake.jpg" alt=""><h3>Pista Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="strawberry .jpg" alt=""><h3>Strawberry Shake</h3><p>‚Çπ85</p></div>
    <div class="card"><img src="vanila ice cream .jpg" alt=""><h3>Vanilla Shake</h3><p>‚Çπ85</p></div>
  </div>

  <div class="menu-category">ü•§ Sugarcane Juice</div>
  <div class="menu-items">
    <div class="card"><img src="sugar_cane_juice.webp" alt=""><h3>Sugarcane Juice 1 Ltr</h3><p>‚Çπ110</p></div>
    <div class="card"><img src="sugarcane-juice2.jpg" alt=""><h3>Sugarcane Juice 2 Ltr</h3><p>‚Çπ200</p></div>
  </div>
</section>

<section id="about"><h2>About Us</h2><p>At Ganesh Fresh Juice Centre, we serve the freshest and healthiest juices made from quality fruits.</p></section>

<section><div class="menu-category">üç± Meals</div><div class="menu-items"><div class="card"><img src="healthy meal.jpg" alt=""><h3>Healthy Meal</h3><p>‚Çπ85</p></div><div class="card"><img src="protein meal.jpg" alt=""><h3>Protein Meal</h3><p>‚Çπ90</p></div></div></section>

<section id="gallery"><h2>Our Gallery</h2><p class="small">üì∏ Take a look at our shop and fresh juice creations!</p><div class="menu-items"><div class="card"><img src="j1.jpg" alt=""><h3>Our Juice Centre</h3></div><div class="card"><img src="j2.jpg" alt=""><h3>Inside the Shop</h3></div><div class="card"><img src="j3.jpg" alt=""><h3>Fresh Juices</h3></div></div></section>

<section id="delivery">
  <h1>Home Delivery</h1>
  <div class="delivery-box">
    <div><p style="margin:0">üöö We now offer <b>home delivery</b>!</p><p class="small" style="margin:.5rem 0">‚úî Minimum Order: ‚Çπ249 ¬∑ ‚úî Delivery Hours: 9 AM ‚Äì 9 PM</p></div>
    <div style="text-align:right"><a href="#contact" class="btn">Contact / Order</a></div>
  </div>

  <h3>Place Your Order Online</h3>
  <form id="orderForm">
    <input type="text" name="name" placeholder="Your Name" required/>
    <input type="tel" name="phone" placeholder="Phone Number" required/>
    <textarea name="address" placeholder="Delivery Address" rows="3" required></textarea>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <label class="small">Distance from shop (km):</label>
      <input type="number" id="distanceInput" step="0.1" min="0" value="1" style="width:120px"/>
      <div class="small">(Used to calculate delivery fee)</div>
    </div>

    <div id="cart">
      <div class="order-item">
        <select class="item" required>
          <option value="">Select Item</option>
          <optgroup label="Juices">
            <option>Apple Juice - ‚Çπ70</option>
            <option>Orange Juice - ‚Çπ50</option>
            <option>Pineapple Juice - ‚Çπ50</option>
            <option>Grape Juice - ‚Çπ50</option>
            <option>Pulpy Grape - ‚Çπ50</option>
            <option>Watermelon Juice - ‚Çπ45</option>
            <option>Musk Melon Juice - ‚Çπ50</option>
            <option>Carrot Juice - ‚Çπ65</option>
            <option>ABC Juice - ‚Çπ80</option>
            <option>Amla Juice - ‚Çπ60</option>
            <option>Beetroot Juice - ‚Çπ60</option>
            <option>Lemon Juice - ‚Çπ35</option>
            <option>Mosambi Juice - ‚Çπ50</option>
          </optgroup>
          <optgroup label="Shakes">
            <option>Apple Shake - ‚Çπ70</option>
            <option>Banana Shake - ‚Çπ45</option>
            <option>Butter Fruit Shake - ‚Çπ85</option>
            <option>Papaya Shake - ‚Çπ55</option>
            <option>Pomegranate Shake - ‚Çπ75</option>
            <option>Mango Shake - ‚Çπ75</option>
            <option>Kiwi Shake - ‚Çπ75</option>
            <option>Anjeer Shake - ‚Çπ70</option>
            <option>Dry Fruit Shake - ‚Çπ120</option>
            <option>Dates Shake - ‚Çπ80</option>
            <option>Oreo Shake - ‚Çπ70</option>
            <option>Cold Badam - ‚Çπ55</option>
            <option>Cold Coffee - ‚Çπ65</option>
            <option>Chocolate Coffee - ‚Çπ75</option>
            <option>Rose Milk - ‚Çπ55</option>
            <option>Sharja - ‚Çπ75</option>
            <option>Tender Coconut Shake - ‚Çπ85</option>
            <option>Sapota Shake - ‚Çπ60</option>
          </optgroup>
          <optgroup label="Lassi">
            <option>Sweet Lassi - ‚Çπ45</option>
            <option>Banana Lassi - ‚Çπ60</option>
            <option>Apple Lassi - ‚Çπ65</option>
            <option>Mango Lassi - ‚Çπ65</option>
            <option>Pineapple Lassi - ‚Çπ55</option>
            <option>Fruit Lassi - ‚Çπ75</option>
          </optgroup>
          <optgroup label="Ice Cream Shakes">
            <option>Butterscotch Shake - ‚Çπ85</option>
            <option>Chocolate Shake - ‚Çπ85</option>
            <option>Pista Shake - ‚Çπ85</option>
            <option>Strawberry Shake - ‚Çπ85</option>
            <option>Vanilla Shake - ‚Çπ85</option>
          </optgroup>
          <optgroup label="Sugarcane Juice">
            <option>Sugarcane Juice 1 Ltr - ‚Çπ110</option>
            <option>Sugarcane Juice 2 Ltr - ‚Çπ200</option>
          </optgroup>
          <optgroup label="Meals">
            <option>Healthy Meal - ‚Çπ85</option>
            <option>Protein Meal - ‚Çπ90</option>
          </optgroup>
        </select>
        <input type="number" class="quantity" min="1" value="1" required style="width:80px"/>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" onclick="addItem()">‚ûï Add Item</button>
        <button type="button" onclick="removeLastItem()">‚ûñ Remove Last</button>
      </div>

      <div class="totals" id="totalsDisplay">
        <div class="box">Subtotal: <span id="subtotal">‚Çπ0</span></div>
        <div class="box">Delivery: <span id="deliveryFee">‚Çπ0</span></div>
        <div class="box">Total: <span id="grandTotal">‚Çπ0</span></div>
      </div>
    </div>

    <!-- NEW: Separate Share buttons (standalone) -->
    <div class="share-row">
      <button type="button" id="shareLocationBtn" class="btn">Share My Current Location</button>
      <button type="button" id="manualStopShareBtn" class="btn-secondary">Stop Sharing (manual)</button>
      <div style="margin-left:8px" class="small muted">You can share location now (no order) or after placing order.</div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button type="submit" id="submitOrder" class="btn">Submit Order via WhatsApp</button>
    </div>

    <div id="orderWarnings" style="color:#b71c1c;font-weight:700"></div>
  </form>
</section>

<section id="contact">
  <h2>Contact Us</h2>
  <p>üìç GR Building, Nagavarapalya Main Road Bangalore 560093</p>
  <p>üìû +91 99025 93591</p>
  <p>‚úâÔ∏è jnaneshappu85@gmail.com</p>
</section>

<footer style="padding:18px;text-align:center;background:#222;color:#fff">¬© 2025 Ganesh Fresh Juice Centre</footer>

<div class="floating-order" id="floatOrderBtn">üõí</div>

<!-- Tracking panel -->
<div id="trackingPanel" class="tracking-panel" aria-live="polite">
  <div><strong>Order:</strong> <span id="tpOrderNo">‚Äî</span></div>
  <div style="margin-top:6px"><strong>Last location:</strong></div>
  <div id="tpCoords" class="small">waiting‚Ä¶</div>
  <div id="tpAddress" class="small muted" style="margin-top:6px">Address: ‚Äî</div>
  <div style="margin-top:6px"><a id="tpMapLink" href="#" target="_blank" class="small">Open in Google Maps</a></div>
  <div style="margin-top:8px;display:flex;gap:6px">
    <button id="btnStopShare" class="btn-secondary" style="flex:1">Stop Sharing</button>
    <button id="btnDelivered" class="btn" style="flex:1;background:#0b853b">Delivered</button>
  </div>
  <div id="tpStatus" class="small muted" style="margin-top:8px"></div>
</div>

<!-- Owner dashboard -->
<div id="ownerPanel" class="owner-panel">
  <h4>Owner Dashboard</h4>
  <div class="small muted">Paste Apps Script Web App URL and Start Polling</div>
  <div style="display:flex;gap:8px;margin-top:8px">
    <input id="appsUrlInput" placeholder="Apps Script Web App URL" style="flex:1;padding:8px"/>
    <button id="applyAppsBtn">Apply</button>
  </div>
  <div style="display:flex;gap:8px;margin-top:8px">
    <input id="pollInterval" type="number" value="6" style="width:70px;padding:8px"/>
    <button id="startOwnerBtn">Start</button>
    <button id="stopOwnerBtn" disabled>Stop</button>
  </div>
  <div class="owner-list" id="ownerList" style="margin-top:8px;max-height:300px;overflow:auto">
    <div class="small muted">No data ‚Äî start polling</div>
  </div>
</div>

<!-- Confirmation -->
<div class="confirm-overlay" id="confirmOverlay" aria-hidden="true">
  <div class="confirm-box">
    <h3>Order Placed</h3>
    <p>Thank you ‚Äî your order is being prepared.</p>
    <p>Order Number:</p>
    <div class="orderno" id="confirmOrderNo">GFJ-0000</div>
    <p class="small muted" id="confirmSummary"></p>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
      <button id="copyOrderBtn">Copy Order</button>
      <button id="closeConfirmBtn">Close</button>
    </div>
  </div>
</div>

<script>
/* ----------------- CONFIG ----------------- */
let APPS_SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL"; // replace or paste in Owner panel
const SHOP_PHONE = "919902593591";
const MIN_ORDER = 249;
const FREE_RADIUS_KM = 2;
const EXTRA_PER_KM = 15;

/* utilities */
function makeWhatsAppUrl(phone,text){ return "https://wa.me/" + phone + "?text=" + encodeURIComponent(text); }
document.getElementById('floatOrderBtn').addEventListener('click', ()=>{ document.getElementById('delivery').scrollIntoView({behavior:'smooth'}); setTimeout(()=>document.querySelector("#orderForm input[name='name']").focus(),600); });

/* reveal cards */
function observeCards(){ const cards=document.querySelectorAll('.card'); if(!('IntersectionObserver' in window)){cards.forEach(c=>c.classList.add('visible'));return;} const obs=new IntersectionObserver((entries,o)=>{entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');o.unobserve(e.target);}})},{threshold:.12});cards.forEach(c=>obs.observe(c));}
setTimeout(observeCards,300);

/* cart helpers */
function addItem(){ const cart=document.getElementById('cart'); const tpl=document.querySelector('.order-item'); const clone=tpl.cloneNode(true); clone.querySelector('.item').selectedIndex=0; clone.querySelector('.quantity').value=1; cart.appendChild(clone); attachChangeListenersToRow(clone); calculateTotals(); }
function removeLastItem(){ const items=document.querySelectorAll('.order-item'); if(items.length>1){ items[items.length-1].remove(); calculateTotals(); } else alert('You must have at least one item.'); }
function extractPrice(text){ const m = text.match(/‚Çπ\s*([0-9]+(?:\.[0-9]+)?)/); if(m) return parseFloat(m[1]); const mm = text.match(/(\d+)\s*$/); return mm?parseFloat(mm[1]):0; }
function calculateTotals(){ const items=document.querySelectorAll('.order-item'); let subtotal=0; items.forEach(it=>{ const sel=it.querySelector('.item'); const qty=Number(it.querySelector('.quantity').value)||0; const price=extractPrice(sel.value||''); subtotal+=price*qty; }); subtotal=Math.round(subtotal); let distance=Number(document.getElementById('distanceInput').value)||0; if(distance<0) distance=0; let deliveryFee=0; if(subtotal===0) deliveryFee=0; else { if(distance<=FREE_RADIUS_KM) deliveryFee=0; else deliveryFee=Math.max(0,Math.ceil(distance-FREE_RADIUS_KM))*EXTRA_PER_KM; } const grandTotal=subtotal+deliveryFee; document.getElementById('subtotal').textContent='‚Çπ'+subtotal; document.getElementById('deliveryFee').textContent='‚Çπ'+deliveryFee; document.getElementById('grandTotal').textContent='‚Çπ'+grandTotal; const warnings=document.getElementById('orderWarnings'); const submitBtn=document.getElementById('submitOrder'); warnings.textContent=''; if(subtotal<MIN_ORDER){ warnings.textContent='Minimum order ‚Çπ'+MIN_ORDER+' is required. Add more items.'; submitBtn.disabled=true; submitBtn.style.opacity=.6; } else { submitBtn.disabled=false; submitBtn.style.opacity=1; } return {subtotal,deliveryFee,grandTotal}; }
function attachChangeListenersToRow(row){ row.querySelector('.item').addEventListener('change', calculateTotals); row.querySelector('.quantity').addEventListener('input', calculateTotals); }
document.querySelectorAll('.order-item').forEach(attachChangeListenersToRow);
document.getElementById('distanceInput').addEventListener('input', calculateTotals);
window.addEventListener('load', calculateTotals);

/* order number */
function generateOrderNumber(){ const now=new Date(); const pad=(n,d=2)=>String(n).padStart(d,'0'); const YYYY=now.getFullYear(),MM=pad(now.getMonth()+1),DD=pad(now.getDate()); const hh=pad(now.getHours()),mm=pad(now.getMinutes()),ss=pad(now.getSeconds()); const rand=Math.floor(Math.random()*900)+100; return `GFJ-${YYYY}${MM}${DD}-${hh}${mm}${ss}-${rand}`; }

/* reverse geocode (Nominatim) */
async function reverseGeocode(lat,lon){
  try{
    const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) return null;
    const data=await res.json();
    return data.display_name||data.name||null;
  }catch(e){console.warn('reverseGeocode',e);return null;}
}

/* Apps Script POST helper */
async function postToAppsScript(payload){
  const url = APPS_SCRIPT_URL || document.getElementById('appsUrlInput').value.trim();
  if(!url || url.includes('YOUR_GOOGLE_APPS_SCRIPT_URL')){ console.warn('Apps Script URL not configured'); return; }
  try{ await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }catch(e){ console.warn('post error',e); }
}

/* tracking */
let watchId=null;
let currentOrderNo=null;
let trackingActive=false;

/* show tracking UI */
function showTrackingPanel(coords, addr){
  const p=document.getElementById('trackingPanel'); p.style.display='block';
  if(coords && coords.lat){ document.getElementById('tpCoords').textContent=`${coords.lat.toFixed(5)}, ${coords.lon.toFixed(5)} (acc ${Math.round(coords.accuracy||0)}m)`; document.getElementById('tpMapLink').href=`https://www.google.com/maps/search/?api=1&query=${coords.lat},${coords.lon}`; if(addr) document.getElementById('tpAddress').textContent=`Address: ${addr}`; }
  else { document.getElementById('tpCoords').textContent='waiting‚Ä¶'; document.getElementById('tpAddress').textContent='Address: ‚Äî'; }
  document.getElementById('tpStatus').textContent = trackingActive ? 'Sharing location' : 'Not sharing';
  if(currentOrderNo) document.getElementById('tpOrderNo').textContent=currentOrderNo;
}

/* start watchPosition */
function startWatchPosition(){
  if(trackingActive) return;
  if(!navigator.geolocation) return;
  trackingActive=true; document.getElementById('tpStatus').textContent='Sharing location...';
  let lastGeocodeAt=0; const GEOCODE_MIN_INTERVAL_MS=30*1000;
  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    const coords={lat:pos.coords.latitude,lon:pos.coords.longitude,accuracy:pos.coords.accuracy};
    showTrackingPanel(coords);
    const now=Date.now();
    if(now-lastGeocodeAt>GEOCODE_MIN_INTERVAL_MS){
      lastGeocodeAt=now; document.getElementById('tpAddress').textContent='Address: looking up...';
      const addr=await reverseGeocode(coords.lat,coords.lon);
      document.getElementById('tpAddress').textContent = addr ? `Address: ${addr}` : 'Address: (not found)';
      await postToAppsScript({action:'update_location',orderNo:currentOrderNo,location:coords,mapLink:`https://www.google.com/maps/search/?api=1&query=${coords.lat},${coords.lon}`,addressDetected:addr||'',timestamp:new Date().toISOString()});
    } else {
      await postToAppsScript({action:'update_location',orderNo:currentOrderNo,location:coords,mapLink:`https://www.google.com/maps/search/?api=1&query=${coords.lat},${coords.lon}`,timestamp:new Date().toISOString()});
    }
  },(err)=>{ console.warn('watchPosition',err); document.getElementById('tpStatus').textContent='Unable to get updates'; },{enableHighAccuracy:true,maximumAge:5000,timeout:15000});
}

/* stop tracking */
function stopTracking(reason='stopped_by_customer'){
  if(watchId!==null && navigator.geolocation.clearWatch){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  trackingActive=false; document.getElementById('tpStatus').textContent='Not sharing';
  if(currentOrderNo) postToAppsScript({action:'stop_sharing',orderNo:currentOrderNo,reason,timestamp:new Date().toISOString()});
}

/* Submit order ‚Äî existing flow (includes initial geolocation attempt and starts watch if allowed) */
document.getElementById('orderForm').addEventListener('submit', function(e){
  e.preventDefault();
  const totals = calculateTotals();
  if(totals.subtotal < MIN_ORDER){ alert('Minimum order ‚Çπ'+MIN_ORDER+' required'); return; }
  const name = this.name.value.trim(); const phone = this.phone.value.trim(); const address = this.address.value.trim(); const distance = Number(document.getElementById('distanceInput').value)||0;
  const itemsEls=document.querySelectorAll('.order-item'); const items=[]; itemsEls.forEach(it=>{ const itv=it.querySelector('.item').value.trim(); const q=Number(it.querySelector('.quantity').value)||0; if(itv&&q>0) items.push(itv+' x '+q); });
  currentOrderNo = generateOrderNumber();
  document.getElementById('confirmOrderNo').textContent=currentOrderNo;
  document.getElementById('confirmSummary').textContent=`Total: ‚Çπ${totals.grandTotal} ¬∑ Items: ${items.length}`;
  document.getElementById('confirmOverlay').classList.add('visible');

  const sendCreateOrder = async (loc) => {
    let addressDetected='';
    if(loc && loc.lat) addressDetected = await reverseGeocode(loc.lat,loc.lon) || '';
    const mapLink = loc ? `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lon}` : '';
    const payload = { action:'create_order', orderNo:currentOrderNo, name, phone, address, distance, items, subtotal:totals.subtotal, delivery:totals.deliveryFee, total:totals.grandTotal, location:loc||null, mapLink, addressDetected:addressDetected||'', timestamp:new Date().toISOString() };
    await postToAppsScript(payload);
    // open WA with info
    const waLines = ["üçπ New Order","Order No: "+payload.orderNo,"Name: "+payload.name,"Phone: "+payload.phone,"Address: "+payload.address,"Distance (km): "+payload.distance,"Items:", ...payload.items, "Subtotal: ‚Çπ"+payload.subtotal, "Delivery: ‚Çπ"+payload.delivery, "Total: ‚Çπ"+payload.total];
    if(payload.mapLink) waLines.push("Location: "+payload.mapLink);
    if(payload.addressDetected) waLines.push("Detected address: "+payload.addressDetected);
    window.open(makeWhatsAppUrl(SHOP_PHONE, waLines.join("\n")), '_blank');
    if(loc){ showTrackingPanel(loc, payload.addressDetected); startWatchPosition(); } else showTrackingPanel(null);
  };

  if(!navigator.geolocation){ alert('Geolocation not supported ‚Äî order sent without live location'); sendCreateOrder(null); return; }

  navigator.geolocation.getCurrentPosition((pos)=>{ const coords={lat:pos.coords.latitude,lon:pos.coords.longitude,accuracy:pos.coords.accuracy}; sendCreateOrder(coords); }, (err)=>{ console.warn('geolocation getCurrentPosition',err); sendCreateOrder(null); }, {enableHighAccuracy:true,timeout:10000,maximumAge:5000});
});

/* NEW: Share current location button (standalone) */
document.getElementById('shareLocationBtn').addEventListener('click', async ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  const btn = document.getElementById('shareLocationBtn'); btn.disabled=true; btn.textContent='Locating‚Ä¶';
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const coords={lat:pos.coords.latitude,lon:pos.coords.longitude,accuracy:pos.coords.accuracy};
    document.getElementById('tpOrderNo').textContent = currentOrderNo || '‚Äî';
    document.getElementById('tpCoords').textContent = `${coords.lat.toFixed(5)}, ${coords.lon.toFixed(5)} (acc ${Math.round(coords.accuracy||0)}m)`;
    document.getElementById('tpMapLink').href = `https://www.google.com/maps/search/?api=1&query=${coords.lat},${coords.lon}`;
    document.getElementById('trackingPanel').style.display='block';
    // reverse geocode
    document.getElementById('tpAddress').textContent='Address: looking up...';
    const addr = await reverseGeocode(coords.lat,coords.lon);
    document.getElementById('tpAddress').textContent = addr ? `Address: ${addr}` : 'Address: (not found)';
    // send a ping to Apps Script so owner sees this location even before order
    await postToAppsScript({ action:'location_ping', orderNo: currentOrderNo||'', location: coords, mapLink:`https://www.google.com/maps/search/?api=1&query=${coords.lat},${coords.lon}`, addressDetected: addr||'', timestamp: new Date().toISOString() });
    // optionally start continuous sharing if user wants
    startWatchPosition();
    btn.disabled=false; btn.textContent='Share My Current Location';
  }, (err)=>{
    alert('Unable to get location: ' + (err.message || err.code)); btn.disabled=false; btn.textContent='Share My Current Location';
  }, {enableHighAccuracy:true,timeout:10000,maximumAge:5000});
});

/* NEW: Manual stop share button in form */
document.getElementById('manualStopShareBtn').addEventListener('click', ()=>{
  if(!confirm('Stop sharing your location?')) return;
  stopTracking('manual_stop_by_customer');
  alert('Location sharing stopped.');
});

/* tracking panel buttons */
document.getElementById('btnStopShare').addEventListener('click', ()=>{
  if(!confirm('Stop sharing location?')) return;
  stopTracking('stopped_by_customer');
  alert('Location sharing stopped.');
});
document.getElementById('btnDelivered').addEventListener('click', ()=>{
  if(!currentOrderNo) return alert('No active order to mark delivered');
  if(!confirm('Mark order delivered?')) return;
  postToAppsScript({action:'order_delivered',orderNo:currentOrderNo,timestamp:new Date().toISOString()});
  stopTracking('delivered_by_customer');
  document.getElementById('tpStatus').textContent='Marked delivered';
});

/* confirm overlay buttons */
document.getElementById('closeConfirmBtn').addEventListener('click', ()=>document.getElementById('confirmOverlay').classList.remove('visible'));
document.getElementById('copyOrderBtn').addEventListener('click', ()=>{ const c=document.getElementById('confirmOrderNo').textContent; navigator.clipboard?.writeText(c).then(()=>{ const b=document.getElementById('copyOrderBtn'); b.textContent='Copied ‚úì'; setTimeout(()=>b.textContent='Copy Order',2000); }).catch(()=>alert('Copy not supported')); });

/* Owner panel */
document.getElementById('ownerToggle').addEventListener('click', (e)=>{ e.preventDefault(); const p=document.getElementById('ownerPanel'); p.style.display = (p.style.display==='none' || p.style.display==='') ? 'block' : 'none'; });
document.getElementById('applyAppsBtn').addEventListener('click', ()=>{ const v=document.getElementById('appsUrlInput').value.trim(); if(!v) return alert('Paste Apps Script URL'); APPS_SCRIPT_URL=v; alert('Applied'); });

let ownerPoller=null;
document.getElementById('startOwnerBtn').addEventListener('click', ()=>{ const url = document.getElementById('appsUrlInput').value.trim() || APPS_SCRIPT_URL; if(!url || url.includes('YOUR_GOOGLE_APPS_SCRIPT_URL')) return alert('Set Apps Script URL'); const secs=Math.max(2,Number(document.getElementById('pollInterval').value)||6); if(ownerPoller) clearInterval(ownerPoller); fetchOwnerData(); ownerPoller=setInterval(fetchOwnerData,secs*1000); document.getElementById('startOwnerBtn').disabled=true; document.getElementById('stopOwnerBtn').disabled=false; });
document.getElementById('stopOwnerBtn').addEventListener('click', ()=>{ if(ownerPoller) clearInterval(ownerPoller); ownerPoller=null; document.getElementById('startOwnerBtn').disabled=false; document.getElementById('stopOwnerBtn').disabled=true; });

async function fetchOwnerData(){
  const url = APPS_SCRIPT_URL || document.getElementById('appsUrlInput').value.trim();
  if(!url){ document.getElementById('ownerList').innerHTML='<div class="small muted">No Apps Script URL set</div>'; return; }
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(json.status !== 'ok'){ document.getElementById('ownerList').innerHTML='<div class="small muted">No data</div>'; return; }
    const rows = json.data || [];
    const html = rows.map(r=>{
      const map = r.mapLink || (r.lat && r.lon ? `https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lon}`:'#');
      const addr = r.addressDetected ? `<div class="small muted">Detected: ${r.addressDetected}</div>` : '';
      return `<div style="border-bottom:1px dashed #eee;padding:8px 0"><div><strong>Order:</strong> ${r.orderNo||'(n/a)'}</div><div class="small muted">${r.timestamp||''} ¬∑ ${r.action||''}</div><div style="margin-top:6px">${r.name||''} ¬∑ ${r.phone||''}</div>${addr}<div style="margin-top:6px"><a href="${map}" target="_blank" class="small">Open in Google Maps</a></div></div>`;
    }).join('');
    document.getElementById('ownerList').innerHTML = html || '<div class="small muted">No orders yet</div>';
  }catch(e){ document.getElementById('ownerList').innerHTML='<div class="small muted">Error fetching ‚Äî check URL/deployment</div>'; }
}

/* beforeunload warning */
window.addEventListener('beforeunload', function(e){ if(trackingActive){ const msg='Location sharing active ‚Äî leaving will stop sharing.'; e.returnValue=msg; return msg; } });

/* Apps Script sample (see earlier responses) - same as before */

</script>
</body>
</html>
